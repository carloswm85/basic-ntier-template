using System.Security.Claims;
using BasicNtierTemplate.Service.Models;
using BasicNtierTemplate.Service.Services.Interfaces;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Logging;


namespace BasicNtierTemplate.Service.Services
{

    public class AdministrationService : IAdministrationService
    {
        private readonly RoleManager<IdentityRole> roleManager;
        private readonly UserManager<ApplicationUser> userManager;
        private readonly ILogger<AdministrationService> logger;

        public AdministrationService(
            RoleManager<IdentityRole> roleManager,
            UserManager<ApplicationUser> userManager,
            ILogger<AdministrationService> logger)
        {
            this.roleManager = roleManager ?? throw new ArgumentNullException(nameof(roleManager));
            this.userManager = userManager ?? throw new ArgumentNullException(nameof(userManager));
            this.logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        // Users
        public Task<ApplicationUser?> FindUserByIdAsync(string userId) => userManager.FindByIdAsync(userId);

        public Task<IList<Claim>> GetUserClaimsAsync(ApplicationUser user) => userManager.GetClaimsAsync(user);

        public Task<IList<string>> GetUserRolesAsync(ApplicationUser user) => userManager.GetRolesAsync(user);

        public Task<IdentityResult> UpdateUserAsync(ApplicationUser user) => userManager.UpdateAsync(user);

        public Task<IdentityResult> DeleteUserAsync(ApplicationUser user) => userManager.DeleteAsync(user);

        public Task<IQueryable<ApplicationUser>> GetAllUsersAsync()
        {
            // Return wrapped Task for compatibility; this is still synchronous IQueryable
            return Task.FromResult(userManager.Users);
        }

        // Claims
        public Task<IdentityResult> RemoveClaimsAsync(ApplicationUser user, IEnumerable<Claim> claims) =>
            userManager.RemoveClaimsAsync(user, claims);

        public Task<IdentityResult> AddClaimsAsync(ApplicationUser user, IEnumerable<Claim> claims) =>
            userManager.AddClaimsAsync(user, claims);

        // Roles
        public IQueryable<IdentityRole> GetAllRoles() => roleManager.Roles;

        public Task<IdentityRole?> FindRoleByIdAsync(string roleId) => roleManager.FindByIdAsync(roleId);

        public Task<IdentityResult> CreateRoleAsync(IdentityRole role) => roleManager.CreateAsync(role);

        public Task<IdentityResult> UpdateRoleAsync(IdentityRole role) => roleManager.UpdateAsync(role);

        public Task<IdentityResult> DeleteRoleAsync(IdentityRole role) => roleManager.DeleteAsync(role);

        public Task<bool> IsUserInRoleAsync(ApplicationUser user, string roleName) => userManager.IsInRoleAsync(user, roleName);

        public Task<IdentityResult> AddUserToRoleAsync(ApplicationUser user, string roleName) => userManager.AddToRoleAsync(user, roleName);

        public Task<IdentityResult> RemoveUserFromRoleAsync(ApplicationUser user, string roleName) => userManager.RemoveFromRoleAsync(user, roleName);

        public async Task<IList<string>> GetUsersInRoleAsync(IdentityRole role)
        {
            var usersInRole = new List<string>();

            foreach (var user in userManager.Users)
            {
                if (await userManager.IsInRoleAsync(user, role.Name))
                    usersInRole.Add(user.UserName);
            }

            return usersInRole;
        }
    }
}